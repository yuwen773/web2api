# 反爬风险评估与应对方案

## 问题：纯 HTTP 请求会触发反爬吗？

**简短回答**：有低风险，但可以通过正确的方式规避。

---

## 1. 太极AI 可能的反爬检查点

基于抓包分析，太极AI 可能检查以下几个方面：

### 1.1 请求头验证（风险：低）

从抓包来看，关键的请求头包括：

| Header | 说明 | 是否必需 |
|--------|------|----------|
| `authorization` | JWT Token | ✅ 必需 |
| `x-app-version` | 版本号 "2.14.0" | ⚠️ 可能必需 |
| `origin` | "https://ai.aurod.cn" | ⚠️ 可能检查 |
| `referer` | "https://ai.aurod.cn/chat" | ⚠️ 可能检查 |
| `user-agent` | 浏览器 UA | ⚠️ 可能检查 |
| `content-type` | "application/json" | ✅ 必需 |
| `accept` | "text/event-stream" | ⚠️ 流式必需 |

**风险分析**：
- ✅ 大多数网站不深度验证这些 headers
- ⚠️ 但缺少可能触发简单的验证

---

### 1.2 Cookie 验证（风险：低）

抓包中有一个 cookie：
```
server_name_session=5521b2b0d0c90d6ccce57cc1912bef3c
```

**风险分析**：
- ❓ 不确定这个 cookie 的作用
- 可能是：
  - CSRF 保护
  - 会话绑定
  - 或者完全无关

**应对**：请求时带上这个 cookie

---

### 1.3 频率限制（风险：中）

所有商业服务都会有频率限制，太极AI 也不例外。

**可能的限制方式**：
- 每 N 秒最多 N 次请求
- 每小时最多 N 次请求
- 每天最多 N 次请求
- 并发连接数限制

**从积分系统推测**：
- 模型显示消耗 "1积分" 或 "1000000积分"
- 说明有计费/限额系统
- VIP 用户有更高额度

---

### 1.4 IP 限制（风险：低-中）

**可能的限制**：
- 单 IP 同时连接数
- 单 IP 每日请求量
- 异常 IP 行为检测

**风险**：如果短时间内大量请求，可能触发 IP 封禁

---

### 1.5 Token 验证（风险：低）

Token 是 JWT，包含：
```json
{
  "userId": 18605,
  "sign": "55408e17d7235215ca88daa63862f64a",
  "role": "user",
  "exp": 1774778503,  // 过期时间
  ...
}
```

**风险分析**：
- ✅ Token 有过期时间（exp 字段）
- ✅ 服务端会验证 token 有效性
- ⚠️ Token 绑定可能绑定了 IP 或设备

---

## 2. 风险等级评估

### 总体风险：🟡 低-中等

| 检查项 | 风险等级 | 触发概率 | 影响 |
|--------|----------|----------|------|
| 请求头验证 | 🟢 低 | 10% | 轻微，修复即可 |
| Cookie 验证 | 🟢 低 | 10% | 轻微，修复即可 |
| 频率限制 | 🟡 中 | 50% | 中等，需控制频率 |
| IP 封禁 | 🟡 中 | 30% | 中等，需谨慎使用 |
| Token 失效 | 🟢 低 | 100% | 轻微，自动续期 |

---

## 3. 对比：浏览器 vs HTTP 的反爬差异

### 浏览器方案的"优势"

很多人认为浏览器自动化更安全，因为：

| 优势 | 实际情况 |
|------|----------|
| "看起来像真人" | ❌ 服务端主要看请求内容，不是看你用什么发的 |
| "有完整的浏览器指纹" | ❌ 太极AI 没有检查指纹 |
| "能执行 JavaScript" | ❌ 太极AI 不需要 JS 计算 |

### 实际上

服务端看到的请求是一样的：

```
HTTP POST /api/chat/completions
Headers: {...}
Body: {...}
```

无论是用浏览器还是 httpx 发的，请求内容完全相同。

**除非** 太极AI 有以下机制：
- Cloudflare/Turnstile（需要浏览器执行 JS）
- 动态签名（需要逆向或浏览器执行）
- TLS 指纹验证（需要真实浏览器）

**但太极AI 没有这些。**

---

## 4. 应对策略

### 策略 1: 完整模拟浏览器请求头

**指示**：
1. 在代码中设置完整的请求头：
   ```python
   headers = {
       "accept": "text/event-stream",
       "accept-language": "zh-CN,zh;q=0.9,en;q=0.8",
       "authorization": f"Bearer {token}",
       "content-type": "application/json",
       "origin": "https://ai.aurod.cn",
       "referer": "https://ai.aurod.cn/chat",
       "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) ...",
       "x-app-version": "2.14.0",
   }
   ```

2. 带上 cookie：
   ```python
   cookies = {"server_name_session": session_cookie}
   ```

---

### 策略 2: 控制请求频率

**指示**：
1. 单次请求间添加延迟：
   ```python
   await asyncio.sleep(1)  # 每次请求间隔 1 秒
   ```

2. 实现令牌桶算法限制并发：
   ```python
   # 最多同时 5 个请求
   semaphore = asyncio.Semaphore(5)
   ```

3. 监控响应状态码：
   - 429 Too Many Requests → 降低频率
   - 403 Forbidden → 暂停并警告

---

### 策略 3: Token 自动续期

**指示**：
1. 捕获 401 错误
2. 自动重新登录获取新 token
3. 重试原请求

---

### 策略 4: 优雅降级

**指示**：
1. 如果连续触发反爬，自动暂停一段时间
2. 记录触发原因
3. 可以切换到浏览器方案（作为备用）

---

## 5. 实际测试方法

在正式使用前，进行以下测试：

### 测试 1: 基础可用性测试

1. 用 httpx 发送 10 条连续消息
2. 观察是否有错误
3. 检查响应状态码

**预期**：全部成功

---

### 测试 2: 频率限制测试

1. 快速发送 50 条消息（无延迟）
2. 观察何时开始失败
3. 记录限制阈值

**预期**：可能在 20-30 条后触发 429

---

### 测试 3: 并发测试

1. 同时发送 10 条消息
2. 观察成功率
3. 检查是否触发 IP 封禁

**预期**：小并发应该可以，大并发可能触发限制

---

### 测试 4: 长时间运行测试

1. 运行服务 24 小时
2. 每隔几分钟发送一条消息
3. 观察 token 是否过期

**预期**：需要定期刷新 token

---

## 6. 最坏情况预案

### 如果 HTTP 方案被封锁

**表现**：
- 持续返回 403 Forbidden
- 账号被封禁
- IP 被封禁

**应对**：
1. 切换到浏览器自动化方案
2. 使用代理 IP 池
3. 降低请求频率
4. 联系客服申诉

---

## 7. 与其他项目对比

### gpt4free 项目

这是最大的逆向 API 项目，支持几十个网站：

- 大多数网站用 HTTP 就行
- 只有少数需要浏览器（如 You.com 的某些功能）
- 太极AI 的复杂度远低于这些网站

### 国内套壳平台的特点

- 通常不会投入大量资源做反爬
- 主要靠账号体系限制
- 依赖官方 API 的风控

---

## 8. 最终建议

### ✅ 推荐做法：先用 HTTP，保留浏览器作为备用

**理由**：
1. HTTP 方案简单、高效、成本低
2. 太极AI 的反爬机制较弱
3. 即使触发，也可以快速切换方案

**实施顺序**：
1. 先实现 HTTP 方案
2. 按上述策略设置请求头和频率控制
3. 进行充分测试
4. 如果有问题，再考虑浏览器方案

---

### ⚠️ 使用注意事项

1. **不要滥用**：即使是合法用户，过度使用也可能被封
2. **遵守服务条款**：不要生成违规内容
3. **控制频率**：自用场景下，正常使用不会触发限制
4. **监控状态**：及时发现问题

---

## 9. 结论

| 问题 | 答案 |
|------|------|
| 会触发反爬吗？ | 🟡 有可能，但概率很低 |
| HTTP 方案能用吗？ | ✅ 可以，正确实施即可 |
| 需要浏览器吗？ | ❌ 不需要，除非 HTTP 方案失败 |
| 安全吗？ | ✅ 自用场景下很安全 |

**核心建议**：

> 太极AI 是一个简单的套壳平台，没有复杂的反爬机制。
> 使用 HTTP + SSE 方案完全可行，只需模拟好请求头、控制好频率。
> 先用 HTTP，有问题再切换，不要过度设计。

---

## 附录：反爬检测速查表

| 检测方式 | 太极AI 有无 | HTTP 能否绕过 |
|----------|-------------|---------------|
| User-Agent 检查 | ✅ 可能有 | ✅ 设置 UA |
| Referer 检查 | ✅ 可能有 | ✅ 设置 Referer |
| Cookie 验证 | ✅ 可能有 | ✅ 带上 Cookie |
| 请求频率限制 | ✅ 几乎肯定 | ✅ 控制频率 |
| IP 限制 | ✅ 可能有 | ✅ 代理 IP |
| Cloudflare | ❌ 无 | N/A |
| 动态签名 | ❌ 无 | N/A |
| TLS 指纹 | ❌ 无 | N/A |
| 人机验证 | ❌ 无 | N/A |

**结论**：所有可能存在的反爬机制都可以通过 HTTP 方案应对。
